### 概念: 通信与计算重叠 (Overlapping Communication and Computation)

#### 1. 核心定义

通信与计算重叠是一种关键的性能优化技术, 用于隐藏分布式计算中的通信延迟. 现代 GPU 等加速器拥有独立的计算单元和数据传输单元 (如 NVIDIA GPU 的 CUDA cores 和 Copy Engines). 这使得 GPU 可以在其计算核心执行数学运算 (如矩阵乘法) 的**同时**, 在后台通过网络接口 (如 NVLink, InfiniBand) 发送或接收数据. 这种并行执行的能力就是重叠的基础.

#### 2. 工作原理

- **无重叠 (Sequential Execution)**:
    1.  **通信**: GPU 等待从网络接收所需的数据 (例如, 模型参数). 在此期间, 计算单元空闲.
    2.  **计算**: 数据接收完毕后, GPU 开始执行计算. 在此期间, 网络接口可能空闲.
    - **问题**: 总执行时间是通信时间和计算时间之和, 通信延迟完全暴露出来, 成为性能瓶颈.

- **有重叠 (Overlapped Execution)**:
    1.  **预取 (Prefetching)**: 程序提前预测下一步计算需要的数据.
    2.  **异步通信**: GPU **异步地**发起数据传输请求 (例如, 请求第 `L+1` 层的参数), 然后**不等待传输完成**, 立即使用**已有的数据** (例如, 第 `L` 层的参数) 开始计算.
    3.  **并行执行**: 当 GPU 的计算单元在处理第 `L` 层的数据时, 其数据传输单元正在后台接收第 `L+1` 层的数据.
    - **效果**: 如果计算第 `L` 层所需的时间大于或等于传输第 `L+1` 层数据的时间, 那么通信延迟就被完全“隐藏”在了计算时间之后. GPU 的计算单元可以无缝地从一个任务切换到下一个, 避免了因等待数据而产生的空闲.

#### 3. 在并行化策略中的应用

通信与计算重叠是多种高级并行策略能够实现高效率的根本原因.

- **[FSDP (Fully Sharded Data Parallel)](./Lecture7-FSDP.md) / ZeRO-3**:
    这是该技术最经典的應用场景. FSDP 在计算当前层时, 会在后台异步地预取 (All-Gather) 下一层所需的参数分片. 正是这种巧妙的调度, 使得 FSDP 尽管通信模式复杂, 却能保持极高的 GPU 利用率.

- **[流水线并行 (Pipeline Parallelism)](./Lecture7-Pipeline-Parallelism.md)**:
    微批次流水线本身就是一种宏观层面的重叠. 当一个 GPU (Stage `i`) 在计算微批次 `k` 时, 它的上一个 GPU (Stage `i-1`) 正在计算微批次 `k+1`, 同时它的下一个 GPU (Stage `i+1`) 正在计算微批次 `k-1`. 整个流水线通过让不同阶段的计算并行起来, 实现了任务级的重叠.

- **数据并行 (Data Parallelism)**:
    在某些实现中, 梯度的 All-Reduce 操作可以在反向传播的过程中, 按层重叠进行. 即, 一旦某一层 (或某几层) 的梯度计算完成, 就可以立即开始对这些梯度进行通信, 而不必等待整个反向传播结束.

#### 4. 总结

在任何大规模分布式系统中, 延迟都是性能的天敌. 通信与计算重叠是通过智能调度来对抗延迟的核心武器. 成功地应用这项技术, 是区分一个普通并行实现和一个高性能并行实现的关键所在.