### 1. 概念定义

**波形量化 (Wave Quantization)** 是在分析 GPU 性能时观察到的一种现象，指的是当计算任务的总量（例如，矩阵乘法所需的线程块总数）发生微小变化时，GPU 的利用率和整体性能可能会出现非线性的、阶梯式的剧烈下降。这种现象的根本原因是 GPU 的调度机制和其有限的、离散的硬件资源（主要是 **[SM](./Lecture5-Streaming-Multiprocessor.md)** 的数量）之间的相互作用。

这个术语形象地描述了 GPU 的工作负载是以“波 (waves)”的形式被处理的。

### 2. 发生机制

GPU 通过将**[线程块 (Blocks)](./Lecture5-GPU-Execution-Model.md)** 分配给可用的 **[SMs](./Lecture5-Streaming-Multiprocessor.md)** 来执行任务。一个现代 GPU（如 A100）拥有固定数量的 SM（例如 108 个）。

假设一个计算任务总共需要 `N` 个线程块来完成。

- **理想情况 (一波完成)**: 如果 `N` 小于或等于 GPU 的 SM 总数（例如 `N = 98`，SM 数为 108），GPU 可以将所有 98 个线程块同时分派到 98 个不同的 SM 上并行执行。在这种情况下，几乎所有的 SM 都在工作，GPU 的利用率非常高。这一轮并行的执行被称为一“波”。

- **次优情况 (多波完成)**: 如果 `N` 略微大于 GPU 的 SM 总数（例如 `N = 120`，SM 数为 108），问题就出现了。GPU 无法一次性处理所有的线程块。它会分多“波”来执行：
    1.  **第一波**: GPU 调度器会首先启动 108 个线程块，将 108 个 SM 完全占满。这一波的执行效率很高。
    2.  **第二波**: 在第一波的 108 个块全部执行完毕后，GPU 会启动剩下的一波，其中包含 `120 - 108 = 12` 个线程块。在执行这一波时，只有 12 个 SM 在工作，而其余的 `108 - 12 = 96` 个 SM 处于完全闲置的状态。

### 3. 性能影响

这种多波执行的模式会导致 GPU 的平均利用率急剧下降。总的执行时间由最慢的一波决定（通常是所有波执行时间的总和）。在上面的例子中，从 98 个块增加到 120 个块，任务量只增加了约 22%，但由于需要两波执行，并且第二波的利用率极低，总的执行时间可能会大幅增加，导致有效吞吐量（如 TFLOP/s）急剧下降。

这就是讲座中性能图表上出现“悬崖式”下跌的原因：当矩阵维度从 1792 增加到 1793 时，所需的分块数量从 98 个跃升到 120 个，恰好跨越了 A100 GPU 108 个 SM 的单波处理能力门槛，从而触发了波形量化效应。

### 4. 如何缓解

- **任务规划**: 在设计并行任务时，应尽量使所需的线程块总数是 SM 数量的整数倍，或者远大于 SM 的数量。
    - **整数倍**: 如果任务需要 216 个块，那么 GPU 可以分两波执行，每一波都占满 108 个 SM，利用率仍然是 100%。
    - **远大于**: 如果任务需要数千个块，那么最后一波的低效执行时间占总时间的比例就会很小，波形量化的影响也会被摊薄。
- **调整分块大小**: 通过调整**[分块 (Tiling)](./Lecture5-Tiling.md)**的大小，可以改变所需的线程块总数，从而可能避开那些会引发严重波形量化效应的“危险”区域。

波形量化是 GPU 宏观调度层面一个非常重要但又容易被忽视的性能陷阱。它揭示了在并行计算中，不仅微观的指令和内存访问模式很重要，宏观的任务划分和资源匹配同样至关重要。