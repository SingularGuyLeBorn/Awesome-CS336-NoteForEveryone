# 技能：图片资源管理

## 核心原则

> **本地化优先**：外部链接会失效，本地图片永远可用。

---

## 一、图片来源优先级

### Tier 1: 最可靠
1. **课程官方 PDF 截图**: 使用 `fitz` (PyMuPDF) 提取
2. **GitHub Raw 链接**: `raw.githubusercontent.com/...`
3. **本地 AI 生成**: 技术架构图可用 AI 绘制

### Tier 2: 较可靠
4. **Hugging Face 文档**: `huggingface.co/datasets/.../resolve/...`
5. **学术博客**: Lilian Weng, Jay Alammar 的博客图片

### Tier 3: 不推荐
6. **Twitter/X 图片**: 经常失效
7. **Medium CDN**: 可能有反爬
8. **随机博客图片**: 稳定性未知

---

## 二、图片获取策略

### 2.1 从 PDF 提取图片

```python
import fitz  # PyMuPDF

def extract_images_from_pdf(pdf_path, output_dir):
    doc = fitz.open(pdf_path)
    for page_num, page in enumerate(doc):
        images = page.get_images(full=True)
        for img_index, img in enumerate(images):
            xref = img[0]
            pix = fitz.Pixmap(doc, xref)
            pix.save(f"{output_dir}/page{page_num}_img{img_index}.png")
```

### 2.2 从 GitHub 下载

```python
import requests

def download_github_image(raw_url, save_path):
    headers = {'User-Agent': 'Mozilla/5.0'}
    response = requests.get(raw_url, headers=headers, timeout=30)
    if response.status_code == 200:
        with open(save_path, 'wb') as f:
            f.write(response.content)
        return True
    return False
```

### 2.3 批量下载模板

```python
images = [
    {"url": "https://raw.githubusercontent.com/.../image1.png", "filename": "image1.png"},
    {"url": "https://raw.githubusercontent.com/.../image2.png", "filename": "image2.png"},
]

for img in images:
    download_github_image(img['url'], f"images/{img['filename']}")
```

### 2.4 AI 生成技术图

当找不到合适图片时，使用 AI 生成：

**Prompt 模板**:
```
Technical diagram showing [概念].

LEFT SIDE: [对比项A] - [描述]
RIGHT SIDE: [对比项B] - [描述]

Clean technical illustration style, white background, 
clear labels, professional diagram suitable for academic paper.
Include a legend showing [图例].
```

---

## 三、图片文件管理

### 3.1 目录结构
```
NoteByHuman/LectureX/
└── images/
    ├── concept1_diagram.png     # 概念图
    ├── architecture_overview.png # 架构图
    ├── comparison_table.png     # 对比图
    └── algorithm_flowchart.png  # 流程图
```

### 3.2 命名规范
- 使用 **小写字母 + 下划线**: `speculative_decoding.png`
- 包含 **语义信息**: 不用 `img1.png`
- 保持 **简洁**: 不超过 30 字符

### 3.3 格式选择

| 格式 | 适用场景 | 特点 |
|------|----------|------|
| PNG | 技术图、截图 | 无损，支持透明 |
| SVG | 矢量图、图标 | 可缩放，文件小 |
| GIF | 动画演示 | 支持动画 |
| WebP | 现代网页 | 压缩好，支持透明 |
| JPEG | 照片 | 有损压缩 |

---

## 四、图片验证流程

### Step 1: 检查文件大小
```python
import os

def validate_image(filepath):
    size = os.path.getsize(filepath)
    if size < 1000:  # 小于 1KB 可能是错误页面
        print(f"WARNING: {filepath} is only {size} bytes")
        return False
    return True
```

### Step 2: 检查文件类型
```python
import imghdr

def check_image_type(filepath):
    img_type = imghdr.what(filepath)
    if img_type is None:
        print(f"WARNING: {filepath} is not a valid image")
        return False
    return True
```

### Step 3: 检查 HTML 污染
有时下载的"图片"实际上是 404 HTML 页面：
```python
def check_html_pollution(filepath):
    with open(filepath, 'rb') as f:
        header = f.read(100)
        if b'<!DOCTYPE' in header or b'<html' in header:
            print(f"WARNING: {filepath} is an HTML file, not an image")
            return False
    return True
```

---

## 五、Markdown 引用规范

### 5.1 基础引用
```markdown
![图片描述](./images/diagram.png)
```

### 5.2 带说明的引用
```markdown
![架构对比图](./images/mha_vs_gqa.png)

*图 1: MHA、GQA、MLA 三种注意力机制的 KV Cache 对比。MLA 通过低秩压缩实现最大的内存节省。*
```

### 5.3 详细描述块
```markdown
![Speculative Decoding 流程](./images/speculative_decoding.png)

> **图片说明**: 
> - Draft Model (小模型) 快速生成 γ 个候选 token
> - Target Model (大模型) 并行验证所有候选
> - 接受匹配的 token，拒绝不匹配的，从拒绝点重新采样
> - 期望加速比: E[tokens/step] = (1-α^(γ+1))/(1-α)
```

---

## 六、常见问题排查

### 问题 1: 图片显示为 broken image
**可能原因**:
- 路径错误 (相对路径 vs 绝对路径)
- 文件名大小写不匹配 (Linux 敏感)
- 文件不存在

**解决方法**:
```bash
# 检查文件是否存在
ls -la images/

# 检查 Markdown 中的路径
grep -r "!\[" *.md
```

### 问题 2: 下载的图片是 404 页面
**解决方法**:
```python
# 检查 Content-Type
response = requests.get(url)
if 'image' not in response.headers.get('content-type', ''):
    print("Not an image!")
```

### 问题 3: GitHub Raw 链接 404
**可能原因**:
- 分支名错误 (`main` vs `master`)
- 文件被删除或移动
- 仓库变为私有

**解决方法**:
- 尝试不同分支: `/refs/heads/main/`, `/refs/heads/master/`
- 搜索 fork 仓库
- 使用 Wayback Machine

---

## 七、自动化工具

### 批量验证脚本
```python
import os

def validate_all_images(image_dir):
    issues = []
    for filename in os.listdir(image_dir):
        filepath = os.path.join(image_dir, filename)
        size = os.path.getsize(filepath)
        
        if size < 1000:
            issues.append(f"{filename}: Too small ({size} bytes)")
        
        with open(filepath, 'rb') as f:
            if b'<html' in f.read(200):
                issues.append(f"{filename}: HTML content detected")
    
    return issues
```

### 链接检查脚本
```python
import re
import os

def check_image_links(md_file, image_dir):
    with open(md_file, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # 提取所有图片引用
    links = re.findall(r'!\[.*?\]\((.*?)\)', content)
    
    missing = []
    for link in links:
        if link.startswith('./images/'):
            filepath = os.path.join(os.path.dirname(md_file), link[2:])
            if not os.path.exists(filepath):
                missing.append(link)
    
    return missing
```
